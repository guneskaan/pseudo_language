/*! asmsimulator 19-02-2019 */
var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(a){return{go:function(b){for(var c=/^[\t ]*(?:([.A-Za-z]\w*)[:])?(?:[\t ]*([A-Za-z]{2,4})(?:[\t ]+(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*)(?:[\t ]*[,][\t ]*(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*))?)?)?/,d=3,e=7,f=/^[-+]?[0-9]+$/,g=/^[.A-Za-z]\w*$/,h=[],i={},j={},k={},l=b.split("\n"),m=function(a){if("0x"===a.slice(0,2))return parseInt(a.slice(2),16);if("0o"===a.slice(0,2))return parseInt(a.slice(2),8);if("b"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),2);if("d"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),10);if(f.exec(a))return parseInt(a,10);throw"Invalid number format"},n=function(a,b,c){var d=o(a);if(void 0!==d)return{type:c,value:d};var e=m(a);if(isNaN(e))throw"Not a "+c+": "+e;if(0>e||e>255)throw c+" must have a value between 0-255";return{type:c,value:e}},o=function(a){return g.exec(a)?a:void 0},p=function(a){switch(a.slice(0,1)){case"[":var b=a.slice(1,a.length-1);return n(b,"regaddress","address");case'"':for(var c=a.slice(1,a.length-1),d=[],e=0,f=c.length;f>e;e++)d.push(c.charCodeAt(e));return{type:"numbers",value:d};case"'":var g=a.slice(1,a.length-1);if(g.length>1)throw"Only one character is allowed. Use String instead";return{type:"number",value:g.charCodeAt(0)};default:return n(a,"register","number")}},q=(function(a){var b=a.toUpperCase();if(b in k)throw"Duplicate label: "+a;if("A"===b||"B"===b||"C"===b||"D"===b)throw"Label contains keyword: "+b;j[a]=h.length}),r=function(a,b){if(void 0!==b)throw a+": too many arguments"},s=0,t=l.length;t>s;s++)try{var u=c.exec(l[s]);if(void 0!==u[1]||void 0!==u[2]){if(void 0!==u[1]&&q(u[1]),void 0!==u[2]){var v,w,x,y=u[2].toUpperCase();switch("DB"!==y&&(i[h.length]=s),y){case"DB":if(v=p(u[d]),"number"===v.type)h.push(v.value);else{if("numbers"!==v.type)throw"DB does not support this operand";for(var z=0,A=v.value.length;A>z;z++)h.push(v.value[z])}break;case"CP":if(v=p(u[d]),w=p(u[e]),"address"===v.type&&"number"===w.type)x=a.CP_NUMBER_TO_ADDRESS;else{if("address"!==v.type||"address"!==w.type)throw"CP does not support this operands";x=a.CP_ADDRESS_TO_ADDRESS}h.push(x,v.value,w.value);break;case"ADD":if(v=p(u[d]),w=p(u[e]),"address"===v.type&&"address"===w.type)x=a.ADD_ADDRESS_TO_ADDRESS;else{if("address"!==v.type||"number"!==w.type)throw"ADD does not support this operands";x=a.ADD_NUMBER_TO_ADDRESS}h.push(x,v.value,w.value);break;case"SUB":if(v=p(u[d]),w=p(u[e]),"address"===v.type&&"address"===w.type)x=a.SUB_ADDRESS_FROM_ADDRESS;else{if("address"!==v.type||"number"!==w.type)throw"SUB does not support this operands";x=a.SUB_NUMBER_FROM_ADDRESS}h.push(x,v.value,w.value);break;case"INC":if(v=p(u[d]),r("INC",u[e]),"address"!==v.type)throw"INC does not support this operand";x=a.INC_ADDRESS,h.push(x,v.value);break;case"DEC":if(v=p(u[d]),r("DEC",u[e]),"address"!==v.type)throw"DEC does not support this operand";x=a.DEC_ADDRESS,h.push(x,v.value);break;case"CMP":if(v=p(u[d]),w=p(u[e]),"address"===v.type&&"address"===w.type)x=a.CMP_ADDRESS_WITH_ADDRESS;else{if("address"!==v.type||"number"!==w.type)throw"CMP does not support this operands";x=a.CMP_NUMBER_WITH_ADDRESS}h.push(x,v.value,w.value);break;case"JP":if(v=p(u[d]),r("JP",u[e]),"number"!==v.type)throw"JP does not support this operands";x=a.JP_ADDRESS,h.push(x,v.value);break;case"JO":if(v=p(u[d]),r(y,u[e]),"number"!==v.type)throw y+" does not support this operand";x=a.JC_ADDRESS,h.push(x,v.value);break;case"JZ":if(v=p(u[d]),r(y,u[e]),"number"!==v.type)throw y+" does not support this operand";x=a.JZ_ADDRESS,h.push(x,v.value);break;case"PRND":if(v=p(u[d]),r(y,u[e]),"address"!==v.type)throw y+" does not support this operand";x=a.PRINT_DECIMAL,h.push(x,v.value);break;case"PRNS":if(v=p(u[d]),r(y,u[e]),"address"!==v.type)throw y+" does not support this operand";x=a.PRINT_STRING,h.push(x,v.value);break;default:throw"Invalid instruction: "+u[2]}}}else{var B=l[s].trim();if(""!==B&&";"!==B.slice(0,1))throw"Syntax error"}}catch(C){throw{error:C,line:s}}for(s=0,t=h.length;t>s;s++)if(!angular.isNumber(h[s])){if(!(h[s]in j))throw{error:"Undefined label: "+h[s]};h[s]=j[h[s]]}return{code:h,mapping:i,labels:j}}}}]),app.service("cpu",["opcodes","memory",function(a,b){var c={step:function(){var c=this;if(c.fault===!0)throw"FAULT. Reset to continue.";try{var d=function(a){return c.zero=!1,c.carry=!1,a>=256?(c.carry=!0,a%=256):0===a?c.zero=!0:0>a&&(c.carry=!0,a=256- -a%256),a},e=function(a){if(0>a||a>=b.data.length)throw"IP outside memory";c.ip=a};if(c.ip<0||c.ip>=b.data.length)throw"Instruction pointer is outside of memory";var f,g,h,i=b.load(c.ip);switch(i){case a.NONE:return!1;case a.CP_NUMBER_TO_ADDRESS:g=b.load(++c.ip),h=b.load(++c.ip),b.store(g,h),c.ip++;break;case a.CP_ADDRESS_TO_ADDRESS:g=b.load(++c.ip),f=b.load(b.load(++c.ip)),b.store(g,f),c.ip++;break;case a.ADD_NUMBER_TO_ADDRESS:g=b.load(++c.ip),srcNum=b.load(g),h=b.load(++c.ip),b.store(g,srcNum+h),c.ip++;break;case a.ADD_ADDRESS_TO_ADDRESS:g=b.load(++c.ip),f=b.load(++c.ip),srcNum=b.load(g),srcNum1=b.load(f),b.store(g,srcNum+srcNum1),c.ip++;break;case a.SUB_NUMBER_FROM_ADDRESS:g=b.load(++c.ip),destNum=b.load(g),h=b.load(++c.ip),b.store(g,d(destNum-h)),c.ip++;break;case a.SUB_ADDRESS_FROM_ADDRESS:g=b.load(++c.ip),f=b.load(++c.ip),number1=b.load(g),number2=b.load(f),b.store(g,d(number1-number2)),c.ip++;break;case a.INC_ADDRESS:g=b.load(++c.ip),h=b.load(g),b.store(g,++h),c.ip++;break;case a.DEC_ADDRESS:g=b.load(++c.ip),h=b.load(g),b.store(g,--h),c.ip++;break;case a.CMP_ADDRESS_WITH_ADDRESS:g=b.load(++c.ip),f=b.load(++c.ip),number1=b.load(g),number2=b.load(f),d(number1-number2),c.ip++;break;case a.CMP_NUMBER_WITH_ADDRESS:g=b.load(++c.ip),number1=b.load(g),number2=b.load(++c.ip),d(number1-number2),c.ip++;break;case a.JP_ADDRESS:h=b.load(++c.ip),e(h);break;case a.JC_ADDRESS:h=b.load(++c.ip),c.carry?e(h):c.ip++;break;case a.JZ_ADDRESS:h=b.load(++c.ip),c.zero?e(h):c.ip++;break;case a.PRINT_DECIMAL:addressFrom=b.load(++c.ip),h=b.load(addressFrom),addressTo=c.sp+1,b.copyString(addressTo,h.toString()),c.ip++;break;case a.PRINT_STRING:for(addressFrom=b.load(++c.ip),addressTo=c.sp+1,count=0,addr=addressFrom,value=b.load(addr++);count<24&&value>0;)++count,value=b.load(addr++);b.copy(addressTo,addressFrom,count),c.ip++;break;default:throw"Invalid op code: "+i}return!0}catch(j){throw c.fault=!0,j}},reset:function(){var a=this;a.maxSP=231,a.minSP=0,a.gpr=[0,0,0,0],a.sp=a.maxSP,a.ip=0,a.zero=!1,a.carry=!1,a.fault=!1}};return c.reset(),c}]),app.service("memory",[function(){var a={data:Array(256),lastAccess:-1,load:function(a){var b=this;if(0>a||a>=b.data.length)throw"Memory access violation at "+a;return b.lastAccess=a,b.data[a]},store:function(a,b){var c=this;if(0>a||a>=c.data.length)throw"Memory access violation at "+a;c.lastAccess=a,c.data[a]=b},copy:function(a,b,c){var d=this;if(0>a||a>=d.data.length||a+c>=d.data.length)throw"Memory access violation at "+a;if(0>b||b>=d.data.length||b+c>=d.data.length)throw"Memory access violation at "+b;if(b>a&&a+c>b)throw"Memory access violation at "+a;for(i=0;i<c;++i)d.data[a+i]=d.data[b+i];d.lastAccess=a+c},copyString:function(a,b){var c=this,d=b.length;if(0>a||a>=c.data.length||a+d>=c.data.length)throw"Memory access violation at "+a;for(i=0;i<d;++i){var e=b.substr(i,1);"-"===e?e=45:(e>="0"||"9">=e)&&(e=parseInt(e,10)+48),console.log(e),c.data[a+i]=e}c.lastAccess=a+d},reset:function(){var a=this;a.lastAccess=-1;for(var b=0,c=a.data.length;c>b;b++)a.data[b]=0}};return a.reset(),a}]),app.service("opcodes",[function(){var a={NONE:0,CP_ADDRESS_TO_ADDRESS:1,CP_NUMBER_TO_ADDRESS:2,ADD_ADDRESS_TO_ADDRESS:3,ADD_NUMBER_TO_ADDRESS:4,SUB_ADDRESS_FROM_ADDRESS:5,SUB_NUMBER_FROM_ADDRESS:6,INC_ADDRESS:7,DEC_ADDRESS:8,CMP_ADDRESS_WITH_ADDRESS:9,CMP_NUMBER_WITH_ADDRESS:10,JP_ADDRESS:11,JC_ADDRESS:12,JZ_ADDRESS:13,PRINT_STRING:14,PRINT_DECIMAL:15};return a}]),app.controller("Ctrl",["$document","$scope","$timeout","cpu","memory","assembler",function(a,b,c,d,e,f){b.memory=e,b.cpu=d,b.error="",b.isRunning=!1,b.displayHex=!0,b.displayInstr=!0,b.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"}],b.speed=4,b.outputStartIndex=232,b.code="; Simple example\n;for (char i = 0; i < 50; ++i)\njp loop\ni: db 0             ;char i = 0;\nloop: cmp [i], 50   ;check i against 50\njz end              ;goto end if i==50\ninc [i]             ;i++\njp loop             ;goto loop\nend:\n",b.reset=function(){d.reset(),e.reset(),b.error="",b.selectedLine=-1},b.executeStep=function(){b.checkPrgrmLoaded()||b.assemble();try{var a=d.step();return d.ip in b.mapping&&(b.selectedLine=b.mapping[d.ip]),a}catch(c){return b.error=c,!1}};var g;b.run=function(){b.checkPrgrmLoaded()||b.assemble(),b.isRunning=!0,g=c(function(){b.executeStep()===!0?b.run():b.isRunning=!1},1e3/b.speed)},b.stop=function(){c.cancel(g),b.isRunning=!1},b.checkPrgrmLoaded=function(){for(var a=0,b=e.data.length;b>a;a++)if(0!==e.data[a])return!0;return!1},b.getChar=function(a){var b=String.fromCharCode(a);return""===b.trim()?"  ":b},b.assemble=function(){try{b.reset();var a=f.go(b.code);b.mapping=a.mapping;var c=a.code;if(b.labels=a.labels,c.length>e.data.length)throw"Binary code does not fit into the memory. Max "+e.data.length+" bytes are allowed";for(var d=0,g=c.length;g>d;d++)e.data[d]=c[d]}catch(h){void 0!==h.line?(b.error=h.line+" | "+h.error,b.selectedLine=h.line):b.error=h.error}},b.jumpToLine=function(c){a[0].getElementById("sourceCode").scrollIntoView(),b.selectedLine=b.mapping[c]},b.isInstruction=function(a){return void 0!==b.mapping&&void 0!==b.mapping[a]&&b.displayInstr},b.getMemoryCellCss=function(a){return a>=b.outputStartIndex?"output-bg":b.isInstruction(a)?"instr-bg":""},b.getMemoryInnerCellCss=function(a){return a===d.ip?"marker marker-ip":""}}]),app.filter("flag",function(){return function(a){return a.toString().toUpperCase()}}),app.filter("number",function(){return function(a,b){if(b){var c=a.toString(16).toUpperCase();return 1==c.length?"0"+c:c}return a.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(a,b,c,d){a.$watch("selectedLine",function(){if(a.selectedLine>=0){for(var c=b[0].value.split("\n"),d=0,e=0;e<c.length&&e!=a.selectedLine;e++)d+=c[e].length+1;var f=c[a.selectedLine].length+d;if("undefined"!=typeof b[0].selectionStart&&(b[0].focus(),b[0].selectionStart=d,b[0].selectionEnd=f),document.selection&&document.selection.createRange){b[0].focus(),b[0].select();var g=document.selection.createRange();g.collapse(!0),g.moveEnd("character",f),g.moveStart("character",d),g.select()}}})}}}]),app.filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(a,b,c,d){b.bind("keydown",function(a){if(9===a.keyCode){var b=this.value,c=this.selectionStart,d=this.selectionEnd;return this.value=b.substring(0,c)+"	"+b.substring(d),this.selectionStart=this.selectionEnd=c+1,a.preventDefault(),!1}})}}}]);